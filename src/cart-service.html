<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<dom-module id="cart-service">
<template>
 <iron-ajax
     	    id="addtocartajax"
     	    url="{{url}}"
     	    handle-as="json"
     	    content-type="application/json"
            on-response="addtocartResponse"
            debounce-duration="300">
 </iron-ajax>
 <iron-ajax
       	      id="addtocartreadajax"
       	      url="http://zencouch-zencodoo.rhcloud.com/grocery/7ec490c42d90eb6cf3b53b8afd000157"
       	      handle-as="json"
       	      content-type="application/json"
              on-response="addtocartreadResponse"
              debounce-duration="300">
 </iron-ajax>
 <iron-ajax
        method="POST"
        id="addtocartwriteajax"
        url="http://zencouch-zencodoo.rhcloud.com/grocery/"
        body=""
        handle-as="json"
        content-type="application/json">
 </iron-ajax>
  <!--fetch the item of particular user and display in view card-->
  <iron-ajax
       	      id="viewcartajax"
       	      url="http://zencouch-zencodoo.rhcloud.com/grocery/7ec490c42d90eb6cf3b53b8afd000157"
       	      handle-as="json"
       	      content-type="application/json"
              on-response="viewcartResponse"
              debounce-duration="300">
 </iron-ajax>
 <!--deleting cart items-->
    <iron-ajax
  	           	      id="deletecartitemserviceajax"
  	           	      url="http://zencouch-zencodoo.rhcloud.com/grocery/7ec490c42d90eb6cf3b53b8afd000157"
  	           	      handle-as="json"
  	           	      content-type="application/json"
  	                  on-response="deletecartitemserviceResponse"
  	                  debounce-duration="300">

  </iron-ajax>
   <!--After deleting cart item updating cart-->
   <iron-ajax
          method="POST"
          id="deleteupdatewriteajax"
          url="http://zencouch-zencodoo.rhcloud.com/grocery/"
          body=""
          handle-as="json"
         content-type="application/json"></iron-ajax>
 </template>
<script>
  (function() {
      var itemval=[];
      var quantity;
      var total;
       var countarr=[];
       var offerlist=[];
       var offerarr=[];
    Polymer({
            is: "cart-service",
            ready:function()
	        {
	        },
            addtocartResponse:function(e)
            {
		   this.itemlist=[];
	       this.itemlist=e.detail.response;
           for(var n=0;n<this.itemlist.rows.length;n++)
           {
           itemval={"type":"","category":"","itemid":"","img":"","name": "","unit": "","price":"","offer":"","flag":"","brand":"","status":"","quantity":"","total":"","cartstatus":""};
           itemval.type=this.itemlist.rows[n].value.type;
   		   itemval.category=this.itemlist.rows[n].value.category;
   		   itemval.itemid=this.itemlist.rows[n].value.itemid;
   		   itemval.img=this.itemlist.rows[n].value.img;
   		   itemval.name=this.itemlist.rows[n].value.name;
   		   itemval.unit=this.itemlist.rows[n].value.unit;
   		   itemval.price=this.itemlist.rows[n].value.price;
   		   itemval.offer=this.itemlist.rows[n].value.offer;
   		   itemval.flag=this.itemlist.rows[n].value.flag;
   		   itemval.brand=this.itemlist.rows[n].value.brand;
   		   itemval.status=this.itemlist.rows[n].value.status;
   		   itemval.quantity=quantity;
   		   itemval.total=total;
   		   itemval.cartstatus="Incart";
           this.$.addtocartreadajax.generateRequest();
		  }

            },
            addtocartservice:function(itemid,name,quant,tot)
            {
           quantity=quant;
           total=tot;
		   this.itemid=JSON.stringify(itemid);
	       this.url="http://zencouch-zencodoo.rhcloud.com/grocery/_design/addtocartdesign/_view/addtocartview?key="+this.itemid;
           this.$.addtocartajax.generateRequest();

            },
            addtocartreadResponse:function(e)
            {
					  this.temparr=[];
					  var len="0";
            		  var flag="0";
            		  var itemcnt=0;
            		  var confirmflag=0;
		              var user=sessionStorage.getItem("info");
		              this.addtocart=e.detail.response.addtocart;
		              this.id=e.detail.response._id;
		  		      this.header=e.detail.response._rev;
		              for(var i=0;i<this.addtocart.length;i++)
		              {
		              if(this.addtocart[i].name==user)
		              {
		              flag="1";
		              //alert(this.addtocart[i].cartitem.length);
		              if(this.addtocart[i].cartitem.length==0)
		              {
		              len="1";
		              }
		              for(var j=0;j<this.addtocart[i].cartitem.length;j++)
		              {
		              var tempval={"type":"","category":"","itemid":"","img":"","name": "","unit": "","price":"","offer":"","flag":"","brand":"","status":"","quantity":"","total":"","cartstatus":""};
		              if(JSON.parse(this.itemid)==this.addtocart[i].cartitem[j].itemid)
		              {
		              itemcnt=1;
		              if(confirm("Item already exist,Do you want to proceed?")==true)
		              confirmflag=1;
		              else
		              confirmflag=0;

           				tempval.type=this.addtocart[i].cartitem[j].type;
   		   				tempval.category=this.addtocart[i].cartitem[j].category;
   		   				tempval.itemid=this.addtocart[i].cartitem[j].itemid;
   		   				tempval.img=this.addtocart[i].cartitem[j].img;
   		   				tempval.name=this.addtocart[i].cartitem[j].name;
   		   				tempval.unit=this.addtocart[i].cartitem[j].unit;
   		   				tempval.price=this.addtocart[i].cartitem[j].price;
   		   				tempval.offer=this.addtocart[i].cartitem[j].offer;
   		   				tempval.flag=this.addtocart[i].cartitem[j].flag;
   		   				tempval.brand=this.addtocart[i].cartitem[j].brand;
   		   				tempval.status=this.addtocart[i].cartitem[j].status;
   		   	   		    tempval.quantity=parseInt(this.addtocart[i].cartitem[j].quantity)+quantity;
   		   				tempval.total=this.addtocart[i].cartitem[j].total;
   		   				tempval.cartstatus=this.addtocart[i].cartitem[j].cartstatus;
   		   				this.temparr.push(tempval);
		              }
		              else
		              {

		              this.temparr.push(this.addtocart[i].cartitem[j]);
		              }

		              }
		              if(itemcnt>0)
		              {
		              this.addtocart[i].cartitem=[];
		              for(var v=0;v<this.temparr.length;v++)
		              this.addtocart[i].cartitem.push(this.temparr[v]);
		              }
		              else
		              {
		              confirmflag=1;
		              this.addtocart[i].cartitem.push(itemval);

		              }
		             /* if(len=="1")
		              {
		              confirmflag=1;
		               this.addtocart[i].cartitem.push(itemval);
		              }*/
		              }
		              }
		              if(flag=="1")
		              {
		              var obj={"_id": "","_rev":"","addtocart":""};
		              obj._id=this.id;
					  obj._rev=this.header;
			          obj.addtocart=this.addtocart;
					  this.$.addtocartwriteajax.body=JSON.stringify(obj);
					  if(confirmflag==1)
					  {
					  this.$.addtocartwriteajax.generateRequest();
		              alert("Item Added!!");
		              }
		              }
		              if(flag=="0")
		              {
		             var newcart={"name":"","cartitem":""};
		             newcart.name=user;
		             newcart.cartitem=[];
		             newcart.cartitem.push(itemval);
		             this.addtocart.push(newcart);
		             var obj={"_id": "","_rev":"","addtocart":""};
		  		     obj._id=this.id;
		  		     obj._rev=this.header;
		  		     obj.addtocart=this.addtocart;
		  		     this.$.addtocartwriteajax.body=JSON.stringify(obj);
		             this.$.addtocartwriteajax.generateRequest();
		             alert("Item Added!!");
		              }
            },
              //view cart of the user
			            viewcart:function()
			            {
			          //alert('app cart');
			          this.$.viewcartajax.generateRequest();
			            },

			viewcartResponse:function(e)
			{
			var flag="0";
			this.viewcartitem=[];
			this.itemview=[];
			this.itemview=e.detail.response.addtocart;
			var uname=JSON.stringify(sessionStorage.getItem("info"));
			//alert(JSON.stringify(this.itemview));
			 for(var i=0;i<this.itemview.length;i++)
			            {
			            if(JSON.stringify(this.itemview[i].name)==uname)
			            {
			            if(this.itemview[i].cartitem.length>0)
			            {
			            flag="1";
			            viewcartitem=this.itemview[i].cartitem;
			            //alert('cart'+JSON.stringify(this.itemview[i].cartitem));
			            document.querySelector('my-app').setPage("view card","page1","view card");
			            document.querySelector('viewcart-list').itemarr=this.itemview[i].cartitem;
			            document.querySelector('viewcart-list').reload;
			            }
			            }
			            }
			            if(flag=="0")
			            {
			             document.querySelector('my-app').setPage("No Item","page1","");
			            }

},
<!--Deleting cart items-->
<!--Service call-->
cartitemdeleteservice:function(item)
{
this.deleteitemname=item;
//alert(this.deleteitemname);
this.$.deletecartitemserviceajax.generateRequest();
},
<!--Service call response and refereshing cart items after deletion-->
deletecartitemserviceResponse:function(e)
{

this.tempdeleteitems=[];
this.tempdeleteitems=e.detail.response.addtocart;

this.writedeletedupdate={"_id":"","_rev":"","addtocart":""};
this.writedeletedupdate._id=e.detail.response._id;
this.writedeletedupdate._rev=e.detail.response._rev;

this.addtocart=[];
this.cartitem=[];
this.purchased=[];

//alert(JSON.stringify(this.tempdeleteitems));
for(var i=0;i<this.tempdeleteitems.length;i++)
{
this.addtocartrows={"name":"","cartitem":""};
if(this.tempdeleteitems[i].name==sessionStorage.getItem("info"))
{
for(var j=0;j<this.tempdeleteitems[i].cartitem.length;j++)
{
	if(this.tempdeleteitems[i].cartitem[j].name==this.deleteitemname)
	{
	}
	else
	{
	//alert(JSON.stringify(this.tempdeleteitems[i].cartitem[j]));
	this.cartitem.push(this.tempdeleteitems[i].cartitem[j]);
	//alert(JSON.stringify(this.cartitem));
	}

}
this.addtocartrows.name=this.tempdeleteitems[i].name;
this.addtocartrows.cartitem=this.cartitem;

this.addtocart.push(this.addtocartrows);
//alert(JSON.stringify(this.addtocart));
}
else
	{
this.addtocartrows.name=this.tempdeleteitems[i].name;
this.addtocartrows.cartitem=this.tempdeleteitems[i].cartitem;

this.addtocart.push(this.addtocartrows);
//alert(JSON.stringify(this.addtocart));
	}
}
this.writedeletedupdate.addtocart=this.addtocart;
alert(JSON.stringify(this.writedeletedupdate));
this.$.deleteupdatewriteajax.body=JSON.stringify(this.writedeletedupdate);
this.$.deleteupdatewriteajax.generateRequest();
document.querySelector('cart-service').viewcart();
}

            });
     })();
  </script>
</dom-module>